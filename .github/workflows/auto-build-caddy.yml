auto-build-caddy-final.yml                                                                                                                                                                         â”‚
â”‚                                                                                                                                                                                                    â”‚
â”‚ name: Auto Build Caddy Single File                                                                                                                                                                 â”‚
â”‚                                                                                                                                                                                                    â”‚
â”‚ on:                                                                                                                                                                                                â”‚
â”‚   schedule:                                                                                                                                                                                        â”‚
â”‚     - cron: '0 18 * * 0'                                                                                                                                                                           â”‚
â”‚   workflow_dispatch:                                                                                                                                                                               â”‚
â”‚                                                                                                                                                                                                    â”‚
â”‚ env:                                                                                                                                                                                               â”‚
â”‚   CADDY_REPO: caddyserver/caddy                                                                                                                                                                    â”‚
â”‚   SOURCE_REPO: simtelboy/caddysinglefile                                                                                                                                                           â”‚
â”‚   SOURCE_BRANCH: feature/rate-limit                                                                                                                                                                â”‚
â”‚   TARGET_REPO: simtelboy/eye                                                                                                                                                                       â”‚
â”‚   FORWARDPROXY_COMMIT: fd35bce86f7aa1d8e9ae26755fb13a23e5ffd72f                                                                                                                                    â”‚
â”‚                                                                                                                                                                                                    â”‚
â”‚ jobs:                                                                                                                                                                                              â”‚
â”‚   check-version:                                                                                                                                                                                   â”‚
â”‚     runs-on: ubuntu-latest                                                                                                                                                                         â”‚
â”‚     outputs:                                                                                                                                                                                       â”‚
â”‚       should-build: ${{ steps.compare.outputs.should-build }}                                                                                                                                      â”‚
â”‚       new-version: ${{ steps.get-caddy.outputs.caddy_version }}                                                                                                                                    â”‚
â”‚     steps:                                                                                                                                                                                         â”‚
â”‚       - name: Get latest Caddy version                                                                                                                                                             â”‚
â”‚         id: get-caddy                                                                                                                                                                              â”‚
â”‚         run: |                                                                                                                                                                                     â”‚
â”‚           sudo apt-get update && sudo apt-get install -y jq                                                                                                                                        â”‚
â”‚           RESPONSE=$(curl -s -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" https://api.github.com/repos/${{ env.CADDY_REPO }}/releases/latest)                                             â”‚
â”‚           if [ $? -ne 0 ]; then                                                                                                                                                                    â”‚
â”‚             echo "Failed to fetch Caddy release data"                                                                                                                                              â”‚
â”‚             exit 1                                                                                                                                                                                 â”‚
â”‚           fi                                                                                                                                                                                       â”‚
â”‚           VERSION=$(echo "$RESPONSE" | jq -r '.tag_name' | sed 's/v//')                                                                                                                            â”‚
â”‚           if [ -z "$VERSION" ]; then                                                                                                                                                               â”‚
â”‚             echo "No valid tag_name found, using default version 0.0.0"                                                                                                                            â”‚
â”‚             VERSION="0.0.0"                                                                                                                                                                        â”‚
â”‚           fi                                                                                                                                                                                       â”‚
â”‚           echo "caddy_version=$VERSION" >> $GITHUB_OUTPUT                                                                                                                                          â”‚
â”‚           echo "Latest Caddy version: v$VERSION"                                                                                                                                                   â”‚
â”‚                                                                                                                                                                                                    â”‚
â”‚       - name: Get current Eye version                                                                                                                                                              â”‚
â”‚         id: get-eye                                                                                                                                                                                â”‚
â”‚         run: |                                                                                                                                                                                     â”‚
â”‚           if [ -n "$(curl -s https://api.github.com/repos/${{ env.TARGET_REPO }}/releases/latest | grep 'tag_name')" ]; then                                                                       â”‚
â”‚             VERSION=$(curl -s https://api.github.com/repos/${{ env.TARGET_REPO }}/releases/latest | grep '"tag_name":' | sed -E 's/.*"([^"]+)".*/\1/' | sed 's/v//')                               â”‚
â”‚             echo "current_version=$VERSION" >> $GITHUB_OUTPUT                                                                                                                                      â”‚
â”‚             echo "Current Eye version: v$VERSION"                                                                                                                                                  â”‚
â”‚           else                                                                                                                                                                                     â”‚
â”‚             echo "current_version=0.0.0" >> $GITHUB_OUTPUT                                                                                                                                         â”‚
â”‚             echo "No existing Eye release, will build"                                                                                                                                             â”‚
â”‚           fi                                                                                                                                                                                       â”‚
â”‚                                                                                                                                                                                                    â”‚
â”‚       - name: Compare versions                                                                                                                                                                     â”‚
â”‚         id: compare                                                                                                                                                                                â”‚
â”‚         run: |                                                                                                                                                                                     â”‚
â”‚           NEW_VER="${{ steps.get-caddy.outputs.caddy_version }}"                                                                                                                                   â”‚
â”‚           CUR_VER="${{ steps.get-eye.outputs.current_version }}"                                                                                                                                   â”‚
â”‚           echo "Comparing $NEW_VER > $CUR_VER"                                                                                                                                                     â”‚
â”‚           if [[ "$NEW_VER" > "$CUR_VER" ]]; then                                                                                                                                                   â”‚
â”‚             echo "should-build=true" >> $GITHUB_OUTPUT                                                                                                                                             â”‚
â”‚             echo "Newer version detected: $NEW_VER"                                                                                                                                                â”‚
â”‚           else                                                                                                                                                                                     â”‚
â”‚             echo "should-build=false" >> $GITHUB_OUTPUT                                                                                                                                            â”‚
â”‚             echo "No update needed"                                                                                                                                                                â”‚
â”‚           fi                                                                                                                                                                                       â”‚
â”‚                                                                                                                                                                                                    â”‚
â”‚   build-and-release:                                                                                                                                                                               â”‚
â”‚     needs: check-version                                                                                                                                                                           â”‚
â”‚     if: needs.check-version.outputs.should-build == 'true'                                                                                                                                         â”‚
â”‚     runs-on: ubuntu-latest                                                                                                                                                                         â”‚
â”‚     permissions:                                                                                                                                                                                   â”‚
â”‚       contents: write                                                                                                                                                                              â”‚
â”‚     steps:                                                                                                                                                                                         â”‚
â”‚       - name: Checkout Eye repo                                                                                                                                                                    â”‚
â”‚         uses: actions/checkout@v4                                                                                                                                                                  â”‚
â”‚         with:                                                                                                                                                                                      â”‚
â”‚           token: ${{ secrets.PRIVATE_REPO_TOKEN }}                                                                                                                                                 â”‚
â”‚                                                                                                                                                                                                    â”‚
â”‚       - name: Clone source repo (specific branch)                                                                                                                                                  â”‚
â”‚         uses: actions/checkout@v4                                                                                                                                                                  â”‚
â”‚         with:                                                                                                                                                                                      â”‚
â”‚           repository: ${{ env.SOURCE_REPO }}                                                                                                                                                       â”‚
â”‚           ref: ${{ env.SOURCE_BRANCH }}                                                                                                                                                            â”‚
â”‚           path: source                                                                                                                                                                             â”‚
â”‚           token: ${{ secrets.PRIVATE_REPO_TOKEN }}                                                                                                                                                 â”‚
â”‚                                                                                                                                                                                                    â”‚
â”‚       - name: Set up Docker for Debian 11                                                                                                                                                          â”‚
â”‚         uses: docker/setup-buildx-action@v3                                                                                                                                                        â”‚
â”‚                                                                                                                                                                                                    â”‚
â”‚       - name: Build Caddy using xcaddy in Debian 11                                                                                                                                                â”‚
â”‚         env:                                                                                                                                                                                       â”‚
â”‚           GITHUB_TOKEN: ${{ secrets.PRIVATE_REPO_TOKEN }}                                                                                                                                          â”‚
â”‚         run: |                                                                                                                                                                                     â”‚
â”‚           NEW_VERSION="${{ needs.check-version.outputs.new-version }}"                                                                                                                             â”‚
â”‚           echo "Building with version: $NEW_VERSION"                                                                                                                                               â”‚
â”‚           echo "Building from branch: ${{ env.SOURCE_BRANCH }}"                                                                                                                                    â”‚
â”‚                                                                                                                                                                                                    â”‚
â”‚           cat > Dockerfile << 'EOF'                                                                                                                                                                â”‚
â”‚           FROM debian:11                                                                                                                                                                           â”‚
â”‚           RUN apt-get update && apt-get install -y wget git ca-certificates pkg-config libssl-dev build-essential && rm -rf /var/lib/apt/lists/*                                                   â”‚
â”‚           RUN wget https://go.dev/dl/go1.25.2.linux-amd64.tar.gz && \                                                                                                                              â”‚
â”‚               tar -C /usr/local -xzf go1.25.2.linux-amd64.tar.gz && \                                                                                                                              â”‚
â”‚               rm go1.25.2.linux-amd64.tar.gz                                                                                                                                                       â”‚
â”‚           ENV GOPATH=/root/go                                                                                                                                                                      â”‚
â”‚           ENV PATH=/usr/local/go/bin:/root/go/bin:$PATH                                                                                                                                            â”‚
â”‚           ARG GITHUB_TOKEN                                                                                                                                                                         â”‚
â”‚           RUN git config --global url."https://x-access-token:${GITHUB_TOKEN}@github.com/".insteadOf "https://github.com/"                                                                         â”‚
â”‚           ENV GOPRIVATE=github.com/simtelboy/caddysinglefile                                                                                                                                       â”‚
â”‚           RUN go install github.com/caddyserver/xcaddy/cmd/xcaddy@latest && \                                                                                                                      â”‚
â”‚               ls -la /root/go/bin/                                                                                                                                                                 â”‚
â”‚           WORKDIR /app                                                                                                                                                                             â”‚
â”‚           COPY source/ .                                                                                                                                                                           â”‚
â”‚           ARG FORWARDPROXY_COMMIT                                                                                                                                                                  â”‚
â”‚           RUN CGO_ENABLED=1 /root/go/bin/xcaddy build --output /app/caddy \                                                                                                                        â”‚
â”‚               --with github.com/caddyserver/forwardproxy=github.com/simtelboy/caddysinglefile@${FORWARDPROXY_COMMIT} && \                                                                          â”‚
â”‚               ls -la /app/                                                                                                                                                                         â”‚
â”‚           EOF                                                                                                                                                                                      â”‚
â”‚                                                                                                                                                                                                    â”‚
â”‚           docker build --build-arg GITHUB_TOKEN=${GITHUB_TOKEN} --build-arg FORWARDPROXY_COMMIT=${{ env.FORWARDPROXY_COMMIT }} -t caddy-build .                                                    â”‚
â”‚           docker run --rm -v $(pwd):/output caddy-build cp /app/caddy /output/                                                                                                                     â”‚
â”‚           mv caddy caddy-v${NEW_VERSION}-linux-amd64                                                                                                                                               â”‚
â”‚           chmod +x caddy-v${NEW_VERSION}-linux-amd64                                                                                                                                               â”‚
â”‚           echo "Built caddy binary: $(ls -lh caddy-v${NEW_VERSION}-linux-amd64)"                                                                                                                   â”‚
â”‚                                                                                                                                                                                                    â”‚
â”‚       - name: Create or update Release                                                                                                                                                             â”‚
â”‚         env:                                                                                                                                                                                       â”‚
â”‚           GITHUB_TOKEN: ${{ secrets.PRIVATE_REPO_TOKEN }}                                                                                                                                          â”‚
â”‚         run: |                                                                                                                                                                                     â”‚
â”‚           NEW_VERSION="${{ needs.check-version.outputs.new-version }}"                                                                                                                             â”‚
â”‚           echo "Creating release with version: $NEW_VERSION"                                                                                                                                       â”‚
â”‚           TAG="v$NEW_VERSION"                                                                                                                                                                      â”‚
â”‚           ASSET_PATH="caddy-v${NEW_VERSION}-linux-amd64"                                                                                                                                           â”‚
â”‚                                                                                                                                                                                                    â”‚
â”‚           RELEASE_NOTES="## å¤©ç¥žä¹‹çœ¼ v${NEW_VERSION}                                                                                                                                               â”‚
â”‚                                                                                                                                                                                                    â”‚
â”‚           ### ðŸ“¦ ç¼–è¯‘ä¿¡æ¯                                                                                                                                                                          â”‚
â”‚           - **Caddy ç‰ˆæœ¬**: v${NEW_VERSION}                                                                                                                                                        â”‚
â”‚           - **æºä»£ç åˆ†æ”¯**: \`${{ env.SOURCE_BRANCH }}\`                                                                                                                                           â”‚
â”‚           - **ç¼–è¯‘æ—¶é—´**: $(date -u '+%Y-%m-%d %H:%M:%S UTC')                                                                                                                                      â”‚
â”‚           - **è¿è¡ŒçŽ¯å¢ƒ**: Debian 11+                                                                                                                                                               â”‚
â”‚                                                                                                                                                                                                    â”‚
â”‚           ### ðŸš€ åŠŸèƒ½ç‰¹æ€§                                                                                                                                                                          â”‚
â”‚           - âœ… åŸºäºŽ Caddy v${NEW_VERSION}                                                                                                                                                          â”‚
â”‚           - âœ… é›†æˆæ­£å‘ä»£ç†åŠŸèƒ½                                                                                                                                                                    â”‚
â”‚           - âœ… ç”¨æˆ·ç®¡ç†ç³»ç»Ÿ                                                                                                                                                                        â”‚
â”‚           - âœ… æµé‡ç»Ÿè®¡ä¸Žé™é€Ÿ                                                                                                                                                                      â”‚
â”‚                                                                                                                                                                                                    â”‚
â”‚           ### ðŸ“¥ å®‰è£…æ–¹æ³•                                                                                                                                                                          â”‚
â”‚           \`\`\`bash                                                                                                                                                                               â”‚
â”‚           wget https://github.com/${{ env.TARGET_REPO }}/releases/download/${TAG}/${ASSET_PATH}                                                                                                    â”‚
â”‚           chmod +x ${ASSET_PATH}                                                                                                                                                                   â”‚
â”‚           sudo mv ${ASSET_PATH} /usr/local/bin/caddy                                                                                                                                               â”‚
â”‚           caddy version                                                                                                                                                                            â”‚
â”‚           \`\`\`                                                                                                                                                                                   â”‚
â”‚                                                                                                                                                                                                    â”‚
â”‚           ---                                                                                                                                                                                      â”‚
â”‚           ðŸ¤– æœ¬ç‰ˆæœ¬ç”± GitHub Actions è‡ªåŠ¨ç¼–è¯‘"                                                                                                                                                     â”‚
â”‚                                                                                                                                                                                                    â”‚
â”‚           gh release create "$TAG" --title "å¤©ç¥žä¹‹çœ¼ v${NEW_VERSION}" --notes "$RELEASE_NOTES" "$ASSET_PATH" \                                                                                     â”‚
â”‚             --repo ${{ env.TARGET_REPO }} || echo "Release already exists"                                                                                                                         â”‚
â”‚                                                                                                                                                                                                    â”‚
â”‚           gh release upload "$TAG" "$ASSET_PATH" --repo ${{ env.TARGET_REPO }} --clobber                                                                                                           â”‚
â”‚           echo "âœ… Released v${NEW_VERSION} with binary: $ASSET_PATH"                
