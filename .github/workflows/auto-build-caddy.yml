name: Auto Build Caddy Single File

  on:
    schedule:
      - cron: '0 18 * * 0'  # æ¯å‘¨æ—¥ 18:00 UTC
    workflow_dispatch:       # æ‰‹åŠ¨è§¦å‘

  env:
    CADDY_REPO: caddyserver/caddy
    SOURCE_REPO: simtelboy/caddysinglefile
    SOURCE_BRANCH: feature/rate-limit  # âœ… æ–°å¢žï¼šæŒ‡å®šåˆ†æ”¯
    TARGET_REPO: simtelboy/eye
    FORWARDPROXY_COMMIT: fd35bce86f7aa1d8e9ae26755fb13a23e5ffd72f

  jobs:
    check-version:
      runs-on: ubuntu-latest
      outputs:
        should-build: ${{ steps.compare.outputs.should-build }}
        new-version: ${{ steps.get-caddy.outputs.caddy_version }}
      steps:
        - name: Get latest Caddy version
          id: get-caddy
          run: |
            sudo apt-get update && sudo apt-get install -y jq
            RESPONSE=$(curl -s -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
              https://api.github.com/repos/${{ env.CADDY_REPO }}/releases/latest)
            if [ $? -ne 0 ]; then
              echo "Failed to fetch Caddy release data"
              exit 1
            fi
            VERSION=$(echo "$RESPONSE" | jq -r '.tag_name' | sed 's/v//')
            if [ -z "$VERSION" ] || [ "$VERSION" = "null" ]; then
              echo "No valid tag_name found, using default version 0.0.0"
              VERSION="0.0.0"
            fi
            echo "caddy_version=$VERSION" >> $GITHUB_OUTPUT
            echo "Latest Caddy version: v$VERSION"

        - name: Get current Eye version
          id: get-eye
          run: |
            RESPONSE=$(curl -s -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
              https://api.github.com/repos/${{ env.TARGET_REPO }}/releases/latest)
            if echo "$RESPONSE" | grep -q 'tag_name'; then
              VERSION=$(echo "$RESPONSE" | jq -r '.tag_name' | sed 's/v//')
              echo "current_version=$VERSION" >> $GITHUB_OUTPUT
              echo "Current Eye version: v$VERSION"
            else
              echo "current_version=0.0.0" >> $GITHUB_OUTPUT
              echo "No existing Eye release, will build"
            fi

        - name: Compare versions
          id: compare
          run: |
            NEW_VER="${{ steps.get-caddy.outputs.caddy_version }}"
            CUR_VER="${{ steps.get-eye.outputs.current_version }}"
            echo "Comparing $NEW_VER > $CUR_VER"
            if [[ "$NEW_VER" > "$CUR_VER" ]] || [[ "$NEW_VER" == "0.0.0" ]]; then
              echo "should-build=true" >> $GITHUB_OUTPUT
              echo "Newer version detected: $NEW_VER"
            else
              echo "should-build=false" >> $GITHUB_OUTPUT
              echo "No update needed"
            fi

    build-and-release:
      needs: check-version
      if: needs.check-version.outputs.should-build == 'true'
      runs-on: ubuntu-latest
      permissions:
        contents: write
      steps:
        - name: Checkout Eye repo
          uses: actions/checkout@v4
          with:
            token: ${{ secrets.PRIVATE_REPO_TOKEN }}  # âœ… ä½¿ç”¨ç§æœ‰ Token

        # âœ… ä¿®æ”¹ï¼šä½¿ç”¨ Token å’ŒæŒ‡å®šåˆ†æ”¯å…‹éš†ç§æœ‰ä»“åº“
        - name: Clone private source repo (specific branch)
          uses: actions/checkout@v4
          with:
            repository: ${{ env.SOURCE_REPO }}
            ref: ${{ env.SOURCE_BRANCH }}  # âœ… æŒ‡å®šåˆ†æ”¯
            path: source
            token: ${{ secrets.PRIVATE_REPO_TOKEN }}  # âœ… ä½¿ç”¨ç§æœ‰ Token

        - name: Set up Docker for Debian 11
          uses: docker/setup-buildx-action@v3

        - name: Build Caddy using xcaddy in Debian 11
          env:
            GITHUB_TOKEN: ${{ secrets.PRIVATE_REPO_TOKEN }}  # âœ… ä½¿ç”¨ç§æœ‰ Token
          run: |
            NEW_VERSION="${{ needs.check-version.outputs.new-version }}"
            echo "Building with version: $NEW_VERSION"
            echo "Building from branch: ${{ env.SOURCE_BRANCH }}"

            # åˆ›å»º Dockerfile
            cat > Dockerfile << 'EOF'
            FROM debian:11

            # å®‰è£…ä¾èµ–
            RUN apt-get update && apt-get install -y \
                wget git ca-certificates pkg-config \
                libssl-dev build-essential && \
                rm -rf /var/lib/apt/lists/*

            # å®‰è£… Go 1.25.2
            RUN wget https://go.dev/dl/go1.25.2.linux-amd64.tar.gz && \
                tar -C /usr/local -xzf go1.25.2.linux-amd64.tar.gz && \
                rm go1.25.2.linux-amd64.tar.gz

            # è®¾ç½®çŽ¯å¢ƒå˜é‡
            ENV GOPATH=/root/go
            ENV PATH=/usr/local/go/bin:/root/go/bin:$PATH

            # é…ç½® Git ä½¿ç”¨ Tokenï¼ˆè¿è¡Œæ—¶ä¼ å…¥ï¼‰
            ARG GITHUB_TOKEN
            RUN git config --global url."https://x-access-token:${GITHUB_TOKEN}@github.com".insteadOf "https://github.com"

            # å®‰è£… xcaddy
            RUN go install github.com/caddyserver/xcaddy/cmd/xcaddy@latest && \
                ls -la /root/go/bin/

            WORKDIR /app
            COPY source/ .

            # ç¼–è¯‘ Caddy
            ARG FORWARDPROXY_COMMIT
            RUN CGO_ENABLED=1 /root/go/bin/xcaddy build --output /app/caddy \
                --with github.com/caddyserver/forwardproxy=github.com/simtelboy/caddysinglefile@${FORWARDPROXY_COMMIT} && \
                ls -la /app/
            EOF

            # æž„å»º Docker é•œåƒï¼ˆä¼ é€’ Token å’Œ Commitï¼‰
            docker build \
              --build-arg GITHUB_TOKEN=${{ secrets.PRIVATE_REPO_TOKEN }} \
              --build-arg FORWARDPROXY_COMMIT=${{ env.FORWARDPROXY_COMMIT }} \
              -t caddy-build .

            # æå–äºŒè¿›åˆ¶æ–‡ä»¶
            docker run --rm -v $(pwd):/output caddy-build cp /app/caddy /output/

            # é‡å‘½åäºŒè¿›åˆ¶
            mv caddy caddy-v${NEW_VERSION}-linux-amd64
            chmod +x caddy-v${NEW_VERSION}-linux-amd64

            echo "Built caddy binary: $(ls -lh caddy-v${NEW_VERSION}-linux-amd64)"

        - name: Create or update Release
          env:
            GITHUB_TOKEN: ${{ secrets.PRIVATE_REPO_TOKEN }}  # âœ… ä½¿ç”¨ç§æœ‰ Token
          run: |
            NEW_VERSION="${{ needs.check-version.outputs.new-version }}"
            echo "Creating release with version: $NEW_VERSION"
            TAG="v$NEW_VERSION"
            ASSET_PATH="caddy-v${NEW_VERSION}-linux-amd64"

            # åˆ›å»º Release Notes
            RELEASE_NOTES="## å¤©ç¥žä¹‹çœ¼ v${NEW_VERSION}

            ### ðŸ“¦ ç¼–è¯‘ä¿¡æ¯
            - **Caddy ç‰ˆæœ¬**: v${NEW_VERSION}
            - **æºä»£ç åˆ†æ”¯**: \`${{ env.SOURCE_BRANCH }}\`
            - **ç¼–è¯‘æ—¶é—´**: $(date -u '+%Y-%m-%d %H:%M:%S UTC')
            - **è¿è¡ŒçŽ¯å¢ƒ**: Debian 11+

            ### ðŸš€ åŠŸèƒ½ç‰¹æ€§
            - âœ… åŸºäºŽ Caddy v${NEW_VERSION}
            - âœ… é›†æˆæ­£å‘ä»£ç†åŠŸèƒ½
            - âœ… ç”¨æˆ·ç®¡ç†ç³»ç»Ÿ
            - âœ… æµé‡ç»Ÿè®¡ä¸Žé™é€Ÿ

            ### ðŸ“¥ å®‰è£…æ–¹æ³•
            \`\`\`bash
            # ä¸‹è½½äºŒè¿›åˆ¶
            wget https://github.com/${{ env.TARGET_REPO }}/releases/download/${TAG}/${ASSET_PATH}

            # èµ‹äºˆæ‰§è¡Œæƒé™
            chmod +x ${ASSET_PATH}

            # ç§»åŠ¨åˆ°ç³»ç»Ÿè·¯å¾„
            sudo mv ${ASSET_PATH} /usr/local/bin/caddy

            # éªŒè¯å®‰è£…
            caddy version
            \`\`\`

            ---
            ðŸ¤– æœ¬ç‰ˆæœ¬ç”± GitHub Actions è‡ªåŠ¨ç¼–è¯‘"

            # åˆ›å»º Releaseï¼ˆå¦‚æžœå·²å­˜åœ¨åˆ™è·³è¿‡ï¼‰
            gh release create "$TAG" \
              --title "å¤©ç¥žä¹‹çœ¼ v${NEW_VERSION}" \
              --notes "$RELEASE_NOTES" \
              "$ASSET_PATH" \
              --repo ${{ env.TARGET_REPO }} || echo "Release already exists"

            # ä¸Šä¼ æˆ–æ›´æ–°èµ„äº§
            gh release upload "$TAG" "$ASSET_PATH" \
              --repo ${{ env.TARGET_REPO }} \
              --clobber

            echo "âœ… Released v${NEW_VERSION} with binary: $ASSET_PATH"
