name: Build Rate Limit Feature

on:
  push:
    branches: [ feature/rate-limit ]
  workflow_dispatch:

jobs:
  build:
    name: Build Caddy with Rate Limit
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Get current commit hash
        id: get-commit
        run: |
          COMMIT_HASH=$(git rev-parse HEAD)
          SHORT_HASH="${COMMIT_HASH:0:7}"
          echo "commit_hash=$COMMIT_HASH" >> $GITHUB_OUTPUT
          echo "short_hash=$SHORT_HASH" >> $GITHUB_OUTPUT
          echo "Building with commit: $COMMIT_HASH (short: $SHORT_HASH)"

      - name: Set up Docker for Debian 11
        uses: docker/setup-buildx-action@v3

      - name: Build Caddy using xcaddy in Debian 11
        run: |
          COMMIT_HASH="${{ steps.get-commit.outputs.commit_hash }}"
          SHORT_HASH="${{ steps.get-commit.outputs.short_hash }}"
          echo "Building with commit: $COMMIT_HASH (short: $SHORT_HASH)"

          # ✅ 创建 Dockerfile（使用本地代码）
          cat > Dockerfile << 'EOF'
          FROM debian:11

          # 安装依赖
          RUN apt-get update && apt-get install -y \
              wget git ca-certificates pkg-config \
              libssl-dev build-essential && \
              rm -rf /var/lib/apt/lists/*

          # 安装 Go 1.25.2
          RUN wget https://go.dev/dl/go1.25.2.linux-amd64.tar.gz && \
              tar -C /usr/local -xzf go1.25.2.linux-amd64.tar.gz && \
              rm go1.25.2.linux-amd64.tar.gz

          # 设置环境变量
          ENV GOPATH=/root/go
          ENV PATH=/usr/local/go/bin:/root/go/bin:$PATH

          # 安装 xcaddy
          RUN go install github.com/caddyserver/xcaddy/cmd/xcaddy@latest && \
              ls -la /root/go/bin/

          # 设置工作目录
          WORKDIR /app

          # ✅ 复制当前仓库代码
          COPY . .

          # ✅ 使用本地路径编译（不需要访问远程仓库）
          RUN CGO_ENABLED=1 /root/go/bin/xcaddy build --output /app/caddy \
              --with github.com/caddyserver/forwardproxy=./ && \
              chmod +x /app/caddy && \
              ls -lh /app/caddy
          EOF

          # ✅ 构建（不需要传递 GITHUB_TOKEN）
          docker build -t caddy-ratelimit-build . || {
            echo "Docker build failed"
            exit 1
          }

          # 提取二进制文件
          docker run --rm -v $(pwd):/output caddy-ratelimit-build sh -c "cp /app/caddy /output/caddy && chmod 755 /output/caddy"

          # 重命名
          mv caddy caddy-ratelimit-${SHORT_HASH}-linux-amd64

          # 显示文件信息
          echo "✅ Built caddy binary: $(ls -lh caddy-ratelimit-${SHORT_HASH}-linux-amd64)"

          # 验证二进制文件
          file caddy-ratelimit-${SHORT_HASH}-linux-amd64

          # 清理 Docker 镜像
          docker rmi caddy-ratelimit-build

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: caddy-ratelimit-linux-amd64
          path: caddy-ratelimit-*-linux-amd64
          retention-days: 7
